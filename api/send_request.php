<?php require 'config.php'; header('Content-Type: application/json'); $data = json_decode(file_get_contents("php://input")); $action = isset($data->action) ? $data->action : 'send'; if($action == 'search') { $q = "%".$data->query."%"; $stmt = $conn->prepare("SELECT id, full_name, email FROM users WHERE role='STUDENT' AND (full_name LIKE :q OR email LIKE :q)"); $stmt->execute([':q'=>$q]); echo json_encode($stmt->fetchAll(PDO::FETCH_ASSOC)); exit(); } if($action == 'send') { $student = null; if(isset($data->student_identifier) && strpos($data->student_identifier, '@') !== false) { $stmt = $conn->prepare("SELECT id FROM users WHERE email = ?"); $stmt->execute([$data->student_identifier]); $student = $stmt->fetch(); } else { $student = ['id' => $data->student_identifier]; } if($student) { $req = json_encode(['fromId'=>$data->parent_id, 'fromName'=>$data->parent_name, 'type'=>'PARENT_LINK']); $conn->prepare("UPDATE users SET pending_request_json=? WHERE id=?")->execute([$req, $student['id']]); echo json_encode(["message"=>"Request Sent Successfully"]); } else { echo json_encode(["message"=>"Student not found"]); } }