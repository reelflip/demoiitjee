<?php require 'config.php'; header('Content-Type: application/json'); $data = json_decode(file_get_contents("php://input")); if (!isset($data->email) || !isset($data->password) || !isset($data->name)) { http_response_code(400); echo json_encode(["message" => "Missing required fields"]); exit(); } $id = 0; $maxTries = 10; do { $id = mt_rand(100000, 999999); $check = $conn->prepare("SELECT id FROM users WHERE id = ?"); $check->execute([$id]); $maxTries--; } while ($check->rowCount() > 0 && $maxTries > 0); if ($maxTries <= 0) { http_response_code(500); echo json_encode(["message" => "Could not generate ID. Try again."]); exit(); } $hash = password_hash($data->password, PASSWORD_DEFAULT); try { $stmt = $conn->prepare("INSERT INTO users (id, email, password_hash, full_name, role, is_verified, institute, target_year, target_exam, dob, gender) VALUES (:id, :email, :pass, :name, :role, 1, :inst, :year, :exam, :dob, :gender)"); $stmt->execute([':id' => $id, ':email' => $data->email, ':pass' => $hash, ':name' => $data->name, ':role' => $data->role, ':inst' => isset($data->institute) ? $data->institute : null, ':year' => isset($data->targetYear) ? $data->targetYear : null, ':exam' => isset($data->targetExam) ? $data->targetExam : null, ':dob' => isset($data->dob) ? $data->dob : null, ':gender' => isset($data->gender) ? $data->gender : null]); echo json_encode(["message" => "Registration successful", "id" => $id]); } catch(PDOException $e) { if ($e->getCode() == 23000) { http_response_code(409); echo json_encode(["message" => "Email already registered"]); } else { http_response_code(500); echo json_encode(["error" => "Registration failed", "message" => $e->getMessage()]); } }