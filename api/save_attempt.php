<?php require 'config.php'; header('Content-Type: application/json'); $data = json_decode(file_get_contents("php://input")); if (!isset($data->user_id) || !isset($data->testId)) { http_response_code(400); echo json_encode(["message" => "Missing data"]); exit(); } try { $conn->beginTransaction(); $attemptId = "att_" . time() . "_" . mt_rand(1000,9999); $stmt = $conn->prepare("INSERT INTO test_attempts (id, user_id, test_id, score, total_questions, correct_count, incorrect_count, accuracy_percent) VALUES (:id, :uid, :tid, :score, :total, :correct, :incorrect, :acc)"); $stmt->execute([':id' => $attemptId, ':uid' => $data->user_id, ':tid' => $data->testId, ':score' => $data->score, ':total' => $data->totalQuestions, ':correct' => $data->correctCount, ':incorrect' => $data->incorrectCount, ':acc' => $data->accuracy_percent]); if (isset($data->detailedResults) && is_array($data->detailedResults)) { $stmtDetail = $conn->prepare("INSERT INTO attempt_details (attempt_id, question_id, status, selected_option) VALUES (:aid, :qid, :status, :sel)"); foreach ($data->detailedResults as $res) { $stmtDetail->execute([':aid' => $attemptId, ':qid' => $res->questionId, ':status' => $res->status, ':sel' => isset($res->selectedOptionIndex) ? $res->selectedOptionIndex : null]); } } $conn->commit(); echo json_encode(["message" => "Attempt saved", "attemptId" => $attemptId]); } catch(PDOException $e) { $conn->rollBack(); http_response_code(500); echo json_encode(["error" => "Save failed", "message" => $e->getMessage()]); }